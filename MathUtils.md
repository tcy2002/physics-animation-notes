# 数学基础

## 矢量代数和矢量几何

必备：
- 矢量的点积、叉积、混合积及其运算规律；
- 微分方程，标量对矢量、矢量对矢量的导数和偏导；
- 旋转矩阵、四元数、欧拉角；

[Ahmed A. Shabana](https://api.pageplace.de/preview/DT0400.9780511114205_A24404602/preview-9780511114205_A24404602.pdf)这本书里有较为详细和易懂的数学基础介绍，可参考第二节和附录。

## 线性求解

- 雅可比（Jocabian）矩阵 $J$ ：约束的一阶导矩阵。矢量 $x\in R^n$ 的约束 $C$ 表示为： $f(x)=(\le,\ge) 0$ ，存在若干个这样的约束 $C_1,C_2,...C_m$ ，则雅可比矩阵 $J\in R^{m\times n}$ ：

$$
J=\left[\begin{matrix}
\frac{\partial f_1}{\partial x_1} & \frac{\partial f_1}{\partial x_2} & ... & \frac{\partial f_1}{\partial x_n} \\
\frac{\partial f_2}{\partial x_1} & \frac{\partial f_2}{\partial x_2} & ... & \frac{\partial f_2}{\partial x_n} \\
\vdots & \vdots & \ddots & \vdots \\
\frac{\partial f_m}{\partial x_1} & \frac{\partial f_m}{\partial x_2} & ... & \frac{\partial f_m}{\partial x_n}
\end{matrix}\right]
$$

  类似的还有海森（Hessian）矩阵：约束的二阶导矩阵，但与雅可比矩阵不同的是，每个约束都有一个自己的海森矩阵：

$$
H_i=\left[\begin{matrix}
\frac{\partial^2 f_i}{{\partial x_1}^2} & \frac{\partial^2 f_i}{\partial x_1\partial x_2} & ... & \frac{\partial^2 f_i}{\partial x_1\partial x_n} \\
\frac{\partial^2 f_i}{\partial x_1\partial x_2} & \frac{\partial^2 f_i}{{\partial x_2}^2} & ... & \frac{\partial^2 f_i}{\partial x_2\partial x_n} \\
\vdots & \vdots & \ddots & \vdots \\
\frac{\partial^2 f_i}{\partial x_1\partial x_n} & \frac{\partial^2 f_i}{\partial x_2\partial x_n} & ... & \frac{\partial^2 f_i}{{\partial x_n}^2}
\end{matrix}\right]
$$

  雅可比矩阵描述了各个位置的约束梯度，海森矩阵则描述的是各个位置的约束曲率。

常见的矩阵求解方法：
- 高斯消元法：通过行变换将矩阵化为上三角矩阵，然后回代求解；
- LU分解：将矩阵分解为下三角矩阵 $L$ 和上三角矩阵 $U$ ，然后通过前向后向替换求解；
- Cholesky分解：适用与对称正定矩阵，将矩阵分解为 $LL^T$ ，其中 $L$ 是下三角矩阵；
- QR分解：将矩阵分解为正交矩阵 $Q$ 和上三角矩阵 $R$ ，然后通过回代求解。
- Eigen库有很多线性求解器可用于求解矩阵方程，面向不同的前置条件，还有面向稀疏矩阵的优化，可参考Eigen文档。

迭代方法：
- 雅可比迭代：对于矩阵方程 $Ax=b$ ，其中 $A$ 非奇异且 $a_{ii}\neq 0$ ，将A分解为： $A=D+L+U$ ，其中 $D$ 为包含元素 $a_{ii}$ 的对角矩阵， $L$ 为包含元素 $a_{ij},i<j$ 的严格下三角矩阵， $U$ 为包含元素 $a_{ij},i>j$ 的严格上三角矩阵，迭代过程为：

$$
x^{(k+1)}=-D^{-1}(L+U)x^{(k)}+D^{-1}b
$$

  直观理解：将以下方程组

$$
\begin{cases}
8x_1-3x_2+2x_3=20 \\
4x_1+11x_2-x_3=33 \\
6x_1+3x_2+13x_3=36
\end{cases}
$$

  转化为以下方程组：

$$
\begin{cases}
x_1=(20+3x_2-2x_3)/8 \\
x_2=(33-4x_1+x_3)/11 \\
x_3=(36-6x_1-3x_2)/12
\end{cases}
$$

  使用后一个方程组进行迭代，精确解为 $x=[3,2,1]^T$ ，选择 $x^{(0)}=[0,0,0]^T$ ，迭代5次有 $x=[2.999843,2.000072,1.000061]^T$ 
- Gauss-Seidel迭代：雅可比迭代的改进，在计算 $x_i^{(k+1)}$ 时，使用已经更新的 $x_j^{(k+1)},j<i$ ，而不是直接使用旧的 $x^{(k)}$ ，即：

$$
\begin{cases}
x_1^{(k+1)}=(20+3x_2^{(k)}-2x_3^{(k)})/8 \\
x_2^{(k+1)}=(33-4x_1^{(k+1)}+x_3^{(k)})/11 \\
x_3^{(k+1)}=(36-6x_1^{(k+1)}-3x_2^{(k+1)})/12
\end{cases} 
\tag 3
$$

  即，迭代方程修改为：

$$
x^{(k+1)}=(D-L)^{-1}Ux^{(k)}+(D-L)^{-1}b
$$

  高斯-赛德尔迭代收敛更快。
- Projected Gauss-Seidel迭代（PGS）：在Gauss-Seidel迭代的基础上，对每次迭代后的$x$进行约束，比如求出摩擦约束之后，需要根据库伦定律约束在摩擦系数以内。
- 此类迭代方法的要求是：系数矩阵 $A$ 为满秩方阵，且对角元素非0。当 $A$ 严格对角占优（每行对角线元素绝对值大于其他元素绝对值之和）或对称正定时，对任意初始值都能收敛。

## 非线性优化

这部分内容是刚体仿真中IPC、原始对偶等方法的基础，如果只看基于速度（冲量）的部分可以跳过。

- 序列二次规划（SQP）：将复杂非线性约束问题拆分成一系列简单的二次规划子问题，并且把约束近似为线性函数，解QP子问题得到下一步的搜索方向。
  直观例子：
    - 目标：找到圆 $x^2+y^2=1$ 上距离 $(2,2)$ 最近的点
    - 建模：
        - 目标:  $\text{argmin}_{x,y}(x-2)^2+(y-2)^2$ ，非线性二次函数
        - 约束:  $x^2+y^2-1=0$ ，非线性等式约束
    - 思路：目标函数二次化，约束线性化
    - 迭代过程：从点 $(1,0)$ 开始，此处在约束圆上的切线是 $x=1$ ，所以这一步变成了在直线 $x=1$ 上找距离 $(2,2)$ 最近的点，得到 $(1,2)$ ，然后修正到圆上得到 $(\frac{\sqrt{5}}{5},\frac{2\sqrt{5}}{5})$ ，继续下一次迭代
    - 分析：把圆上找点优化为切线上找点就是约束线性化；在直线 $x=1$ 上找距 $(2,2)$ 最近的点时，可以理解为将 $x=1$ 代入约束方程，得到一个降次后的关于 $y$ 的方程，然后通过 $y=0$ 附近的梯度（雅可比矩阵）和曲率（海森矩阵）构建二次方程，找到最低的位置作为新的位置，实际上这里的目标方程就是二次方程，所以所构建的二次方程和原本的目标方程是完全贴合的。约束线性化的目的：降维，目标函数二次化的目的：方便找最低点
- 牛顿法和拟牛顿法：牛顿法利用二阶导（海森矩阵）来寻找搜索方向，拟牛顿法不直接计算海森矩阵，利用历次迭代的梯度变化估算海森矩阵
  仍然用上面的例子：
    - 构造拉格朗日： $L(x,y,\lambda)=(x-2)^2+(y-2)^2+\lambda\cdot(x^2+y^2-1)$
    - 目标：找到一组 $(x,y,\lambda)$ ，使得$L$的梯度全为0，即找到了 $L$ 的极值点位置（KKT条件）
    - 牛顿法迭代过程：从点 $(1,0)$ 、 $\lambda=0$ 开始，发现梯度方程的结果不为0（残差），那么计算曲率（海森矩阵），用海森矩阵的逆和残差值算出跳跃步长 $(\Delta x,\Delta y, \Delta\lambda)$ ，得到下一个点。牛顿法收敛很快，因为是根据全量海森矩阵计算的步长。
    - 拟牛顿法迭代过程：并不在每一步都计算全量的海森矩阵，而是从单位矩阵 $H_0=I$ 开始，根据前后步骤的梯度变化更新曲率的值。拟牛顿法比牛顿法收敛慢一点，但比纯梯度法快得多。 
    - 与PGS类似，也有投影牛顿法，即获得新的迭代结果后，须投影到约束可行域内，如旋转正交性修正等。
- 内点法：包括障碍函数和原始-对偶方法，原本是用于处理非线性规划（NLP）的方法，但可扩展到凸非线性优化中。
    - 障碍函数：相比于单纯形法在边界上行走，内点法通过边界施加斥力保持在可行域内取点，无法真正碰到边界
        - 目标： $\min c^T x$ 
        - 约束： $Ax\ge b,x\ge 0$ 
        - 构造带惩罚的目标： $\min c^T x-\mu\sum _{i=1}^n \ln(x_i)$ ，转换为平滑无约束问题
    - 迭代过程：设定一个较大的障碍参数$\mu$，用牛顿法解出极小值点，然后逐步减小$\mu$，边界的斥力逐渐减小，向真实问题的最优解靠近。
    - 原始-对偶法：直接使用障碍函数有一个问题：当$x$很小时， $-\ln x$ 的倒数变得很大，导致海森矩阵奇异化，难以精确求解。
        - 对偶目标： $\max b^T y$ 
        - 约束： $A^T y+s=c,y\ge 0$ ， $y$ 是对偶变量， $s$ 是松弛变量
        - 解KKT条件来逐步逼近最优解：
            - $Ax-b=0$ 原问题约束
            - $A^T \lambda +s-c=0$ 对偶问题约束，含松弛变量
            - $XSe-\epsilon e=0$ 互补松弛性，隐含了障碍函数的导数
        - 在原始对偶法中，虽然$x$和$s$也会趋于0，但综合考虑原问题和对偶问题约束条件时，数值稳定性要优于直接求障碍函数导数，可以比较准确地预测$x$和$s$的变化方向。

## 变分

函数是变量到变量的映射，泛函是函数到变量的映射（自变量不是某个值而是某个函数）。假设泛函 $J[\phi]$ ，对函数 $\phi$ 做微小扰动 $\phi'=\phi+\delta \phi$ ，所导致的泛函值的变化 $J'-J$ 就是泛函的变分。

能量变分：
- 能量泛函 $E[u]$ ，经典力学：$E[u]=\int \text{应变能密度} dx - \int \text{外力做功}$ ，应变能密度表示单位变化长度所储存的能量（如弹性势能、接触势能等）
- 泛函的一阶变分： $\delta E = \frac{d}{d\epsilon}E[u+\epsilon\delta u] |_{\epsilon=0}$ ，物理意义：系统状态做微小扰动时，能量的一阶变化量。
- 系统真实的平衡态，是使能量泛函取极值（通常是极小值）的状态，即 $\delta E=0$ . 因此，IPC等方法通过最小化接触势能，将高度复杂的非线性系统转化为基于能量的平滑优化。
